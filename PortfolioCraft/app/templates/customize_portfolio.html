{% extends "base.html" %}
{% block content %}
{# If session.ai_generated_content exists, use it as sections variable for the template #}
{% if session.ai_generated_content %}
{% set sections = session.ai_generated_content %}
{% endif %}

<div id="mainContainer" class="relative min-h-screen font-sans">
    <div class="p-4">
        <a href="{{ url_for('main.dashboard') }}"
            class="inline-flex items-center px-4 py-2 rounded-xl shadow-md text-white bg-[#687FE5] hover:bg-[#566AD1] transition">
            ‚Üê Back
        </a>
    </div>

    <div class="max-w-4xl mx-auto p-6 lg:p-12 pb-24 relative z-10">

        <div class="relative z-10 p-8 mb-8 bg-white rounded-3xl shadow-lg border-b-8 border-transparent"
            style="border-image: linear-gradient(to right, #687FE5, #EBD6FB); border-image-slice: 1;">
            <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                <div class="relative group">
                    <img id="profilePreview"
                        src="{{ url_for('static', filename='profile_pics/' + (current_user.profile_picture or 'default-profile.png')) }}"
                        alt="Profile Picture"
                        class="w-40 h-40 object-cover rounded-full border-4 border-[#EBD6FB] shadow-md transition-all duration-300 transform group-hover:scale-105">
                    <form id="photoForm" action="{{ url_for('main.upload_photo_ajax') }}" method="POST"
                        enctype="multipart/form-data">
                        <label for="profileUpload"
                            class="absolute bottom-2 right-2 cursor-pointer bg-[#687FE5] hover:bg-indigo-700 text-white p-2 rounded-full shadow-lg transition-all duration-300 opacity-90 hover:opacity-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                            <input id="profileUpload" name="photo" type="file" accept="image/*" class="hidden">
                        </label>
                    </form>
                </div>
                <div class="flex-1 text-center md:text-left mt-4 md:mt-0">
                    <input type="text" id="portfolioName"
                        class="text-4xl lg:text-5xl font-extrabold text-[#687FE5] border-b-2 border-transparent focus:border-gray-300 focus:outline-none bg-transparent w-full mb-2"
                        value="{{ current_user.full_name or 'Your Name' }}">
                    <div class="flex items-center justify-center md:justify-start gap-4 mt-2 text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                        </svg>
                        <span>{{ current_user.email }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div
            class="flex flex-col md:flex-row items-center justify-between gap-6 p-6 mb-8 bg-white rounded-3xl shadow-lg">
            <div class="flex-1">
                <h2 class="text-lg font-semibold mb-2 text-gray-700">Choose a Theme</h2>
                <div class="flex gap-4 flex-wrap justify-center md:justify-start">
                    <button type="button"
                        class="theme-btn w-16 h-16 rounded-2xl shadow-lg border-4 border-transparent hover:border-[#687FE5] transition-all duration-300"
                        data-theme="pastel"
                        style="background: linear-gradient(to bottom right, #FEEBF6, #EBD6FB);"></button>
                    <button type="button"
                        class="theme-btn w-16 h-16 rounded-2xl shadow-lg border-4 border-transparent hover:border-[#687FE5] transition-all duration-300"
                        data-theme="lilac"
                        style="background: linear-gradient(to bottom right, #F5F3FF, #C7D2FE);"></button>
                    <button type="button"
                        class="theme-btn w-16 h-16 rounded-2xl shadow-lg border-4 border-transparent hover:border-[#687FE5] transition-all duration-300"
                        data-theme="sunrise"
                        style="background: linear-gradient(to bottom right, #FFF7ED, #FEF3C7);"></button>
                    <button type="button"
                        class="theme-btn w-16 h-16 rounded-2xl shadow-lg border-4 border-transparent hover:border-[#687FE5] transition-all duration-300"
                        data-theme="mint"
                        style="background: linear-gradient(to bottom right, #D1FAE5, #A7F3D0);"></button>
                    <button type="button"
                        class="theme-btn w-16 h-16 rounded-2xl shadow-lg border-4 border-transparent hover:border-[#687FE5] transition-all duration-300"
                        data-theme="bold-modern"
                        style="background: linear-gradient(to bottom right, #FF5733, #FF8D69);"></button>
                </div>
            </div>
            <div class="flex items-center gap-4 mt-4 md:mt-0">
                <button id="addSectionBtn"
                    class="bg-white text-gray-800 font-semibold py-3 px-6 rounded-full shadow-lg border-2 border-gray-300 hover:bg-gray-100 transition-all duration-300 transform hover:scale-105 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                            clip-rule="evenodd" />
                    </svg>
                    Add New Section
                </button>
                <form id="savePortfolioForm" method="POST" action="{{ url_for('main.save_portfolio', slug=slug) }}">
                    <input type="hidden" name="sectionsData" id="sectionsData">
                    <input type="hidden" name="selectedTheme" id="selectedTheme"
                        value="{{ portfolio_theme or 'pastel' }}">
                    <button type="submit"
                        class="bg-[#687FE5] hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105">
                        Save Portfolio
                    </button>
                </form>
            </div>
        </div>

        <div id="sectionsContainer" class="space-y-8">
            {% if sections %}
            {% for section in sections %}
            <div class="bg-white p-8 rounded-3xl shadow-lg border-l-8 border-transparent"
                style="border-image: linear-gradient(to bottom, #687FE5, #EBD6FB); border-image-slice: 1;"
                data-id="{{ loop.index }}">
                <div class="flex justify-between items-center mb-4">
                    <input type="text"
                        class="section-title text-2xl font-bold bg-transparent border-b-2 border-transparent focus:border-gray-300 focus:outline-none w-full"
                        data-id="{{ loop.index }}"
                        value="{{ section.title|default(section.section_title|default('New Section')) }}">
                    <button type="button"
                        class="delete-btn text-red-500 hover:text-red-700 ml-4 transition-transform duration-300 hover:scale-125"
                        data-id="{{ loop.index }}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <textarea
                    class="w-full h-32 border-2 border-gray-200 rounded-xl p-4 resize-y focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 transition-all duration-300 section-textarea"
                    data-id="{{ loop.index }}">{{ section.content|default(section.body|default('', true), true) }}</textarea>
            </div>
            {% endfor %}
            {% else %}

            <div class="bg-white p-8 rounded-3xl shadow-lg border-l-8 border-transparent"
                style="border-image: linear-gradient(to bottom, #687FE5, #EBD6FB); border-image-slice: 1;">
                <div class="flex justify-between items-center mb-4">
                    <input type="text"
                        class="section-title text-2xl font-bold bg-transparent border-b-2 border-transparent focus:border-gray-300 focus:outline-none w-full"
                        data-id="1" value="New Section">
                    <button type="button"
                        class="delete-btn text-red-500 hover:text-red-700 ml-4 transition-transform duration-300 hover:scale-125"
                        data-id="1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <textarea
                    class="w-full h-32 border-2 border-gray-200 rounded-xl p-4 resize-y focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 transition-all duration-300 section-textarea"
                    data-id="1"></textarea>
            </div>
            {% endif %}
        </div>

    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const automatedNames = ["Education", "Experience", "Core Skills", "Soft Skills", "Languages", "About Me", "Contact", "Projects", "Interests"];
        let nextIndex = {{ sections| length if sections else 0
    }};

    const up = document.getElementById("profileUpload");
    const img = document.getElementById("profilePreview");
    const form = document.getElementById("photoForm");

    if (up) {
        up.addEventListener("change", () => {
            if (up.files && up.files[0]) {
                const reader = new FileReader();
                reader.onload = e => img.src = e.target.result;
                reader.readAsDataURL(up.files[0]);

                const fd = new FormData(form);
                fetch(form.action, { method: "POST", body: fd })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            console.log("Photo uploaded successfully!");
                        }
                    })
                    .catch(error => console.error("Error uploading photo:", error));
            }
        });
    }

    const sectionsContainer = document.getElementById("sectionsContainer");
    if (sectionsContainer) {
        new Sortable(sectionsContainer, {
            animation: 150,
            handle: ".section-title",
        });
    }

    document.querySelectorAll("#addSectionBtn").forEach(button => {
        button.addEventListener("click", () => {
            const container = document.getElementById("sectionsContainer");
            const id = "new-" + Date.now();
            const sectionTitle = automatedNames[nextIndex % automatedNames.length];
            nextIndex++;

            const div = document.createElement("div");
            div.className = "bg-white p-8 rounded-3xl shadow-lg border-l-8 border-transparent";
            div.style.borderImage = "linear-gradient(to bottom, #687FE5, #EBD6FB)";
            div.style.borderImageSlice = "1";
            div.dataset.id = id;
            div.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <input type="text" class="section-title text-2xl font-bold bg-transparent border-b-2 border-transparent focus:border-gray-300 focus:outline-none w-full" data-id="${id}" value="${sectionTitle}">
                    <button type="button" class="delete-btn text-red-500 hover:text-red-700 ml-4 transition-transform duration-300 hover:scale-125" data-id="${id}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <textarea class="w-full h-32 border-2 border-gray-200 rounded-xl p-4 resize-y focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 transition-all duration-300 section-textarea" data-id="${id}"></textarea>
            `;
            container.appendChild(div);
        });
    });

    document.addEventListener("click", e => {
        if (e.target.closest(".delete-btn")) {
            e.target.closest("div[data-id]").remove();
        }
    });

    const saveForm = document.getElementById("savePortfolioForm");
    if (saveForm) {
        saveForm.addEventListener("submit", e => {
            const sections = [];
            document.querySelectorAll("#sectionsContainer > div").forEach((div, idx) => {
                const titleEl = div.querySelector(".section-title");
                const contentEl = div.querySelector(".section-textarea");
                const title = titleEl ? titleEl.value : `Section ${idx + 1}`;
                const content = contentEl ? contentEl.value : "";
                if (title.trim() !== "" || content.trim() !== "") {
                    sections.push({ title: title, content: content });
                }
            });
            document.getElementById("sectionsData").value = JSON.stringify(sections);
        });
    }

    const themeButtons = document.querySelectorAll(".theme-btn");
    const selectedThemeInput = document.getElementById("selectedTheme");
    const mainContainer = document.getElementById("mainContainer");

    const themeClasses = {
        'pastel': 'bg-[#FCD8CD]',
        'lilac': 'bg-[#f8f6ff]',
        'sunrise': 'bg-yellow-100',
        'mint': 'bg-green-100',
        'bold-modern': 'bg-red-200'
    };

    const applyTheme = (themeName) => {
        Object.values(themeClasses).forEach(c => mainContainer.classList.remove(c));
        mainContainer.classList.add(themeClasses[themeName]);
    };

    themeButtons.forEach(button => {
        button.addEventListener("click", () => {
            themeButtons.forEach(btn => btn.classList.remove("border-[#687FE5]"));
            button.classList.add("border-[#687FE5]");
            const selectedTheme = button.dataset.theme;
            selectedThemeInput.value = selectedTheme;
            applyTheme(selectedTheme);
        });
    });

    const initialTheme = selectedThemeInput.value;
    const initialButton = document.querySelector(`[data-theme="${initialTheme}"]`);
    if (initialButton) {
        initialButton.classList.add("border-[#687FE5]");
        applyTheme(initialTheme);
    }
});
</script>
{% endblock %}